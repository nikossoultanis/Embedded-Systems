#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#include <unistd.h>
#include <sys/mman.h>
#include <stdio.h>
#include <stdlib.h>
#include <header.h>

#define PIOA_ID 2
#define TC0_ID 17

void FIQ_handler(void);

PIO* pioa = NULL;
AIC* aic = NULL;
TC* tc = NULL;

#define BUT_IDLE 0
#define BUT_PRESSED 1

#define MAX_PWM 1000
#define STEP_PWM 100
#define TIMES_BRIGHTNESS 20

unsigned int PWM_STATE = 0;
unsigned int LED_STATE = 0;
unsigned int previous_button_state;
unsigned int button_state;

unsigned int PWM = 0;
unsigned int BRIGHTNESS_ROLLING = 0;
unsigned int BRIGHTNESS_DIRECTION = 0;
int timer_interrupts = 0;

int main( int argc, const char* argv[] ){
	unsigned int gen;
	STARTUP; / / ??????????S? S?S??????S
	tc->Channel_0.RC = 8192; / / ???????S 1 ????????????
	tc->Channel_0.CMR = 2084; / / SLOW CLOCK , WAVEFORM , D ISABLE CLK ON RC COMPARE
	tc->Channel_0.IDR = 0xFF; / /??????G?????S? ???? ??? ????????
	tc->Channel_0.IER = 0x10; / /????G?????S? ???? ??? RC COMPARE
    tc->Channel_0.CCR = 0x02  // Stop timer
	aic->FFER = (1<<PIOA_ID) | (1<<TC0_ID); / / ? ? ? ??????S 2 , 1 7 ? ? ? ? ? ????? F IQ
	aic->IECR = (1<<PIOA_ID) | (1<<TC0_ID); / /????G?????S? ???????? : P IOA & TC0
	pioa->PUER = 0x01;  / /????G?????S? S?? G????? 0 : PULL-UP

	pioa->ODR = 0x01; / /G????? 0 : ? ? ? ?? ? ? G ?? ??S????
	pioa->CODR = 0x02; / /G????? 1 : ???????? ?????? LOW
	pioa->OER = 0x02; / /G????? 1 : ? ? ? ?? ? ? G ?? ??????
	gen = pioa->ISR; / / P IOA : ????T???S? ??? ????? ? ??????S
	pioa->PER = 0x03; / /G?????S 0 , 1 : G?????? S?????
	gen = tc->Channel_0.SR; / /TC0 : ????T???S? ??? ????? ? ??????S
	aic->ICCR = (1<<PIOA_ID)|(1<<TC0_ID); / / A I C : ????T???S? ??? ????? ? ??????S
	pioa->IER = 0x01 / /????G?????S? ???????? S?? G????? 0
  
 	while( (tmp = getchar()) != ’e’)
	{
    	if (BRIGHTNESS_ROLLING) {
  			if (timer_interrupts == 2 * TIMES_BRIGHTNESS)
  			{
      			timer_interrupts = 0;
      			BRIGHTNESS_DIRECTION ^= 0x01;
  			}
    		if (BRIGHTNESS_DIRECTION == 0) {
    			PWM -= STEP_PWM;
    		}
            if (BRIGHTNESS_DIRECTION == 1) {
                PWM += STEP_PWM;
            }
            if (PWM < 0) {
                PWM = 0;
            }
            if (PWM > MAX_PWM + 1) {
                PWM = MAX_PWM;
            }
  		}
	}
  
    aic->IDCR = (1<<PIOA_ID) | (1<<TC0_ID); / / ??????? ??? A I C i n t e r r u p t s
    tc->Channel_0.CCR = 0x02; / / ??????G?????S? ??? T im e r
    CLEANUP;
    return 0;
}

void FIQ_handler(void)
{
	unsigned int data_in = 0;
	unsigned int fiq = 0;
	unsigned int data_out;
	fiq = aic->IPR; / /??????S??S ????F???????? ??? ???????S? ?? ???????
    
	if( fiq & (1<<PIOA_ID) ){ / /???G??S G ? ? P IOA
		data_in = pioa->ISR; / / ????T???S? ??S ??G?S ??S ???????S
		aic->ICCR = (1<<PIOA_ID); / / ????T???S? ??S ???????S ??? A I C
		data_in = pioa->PDSR; / /???G??S? ????? ??S????
		if( data_in & 0x01 ){ / / ? ???????S ????????S ;
			if(button_state == BUT_IDLE){
				button_state = BUT_PRESSED;
				BRIGHTNESS_ROLLING ^= 0x01;
                if (BRIGHTNESS_ROLLING == 1) {
      				Channel_0_CCR = 0x05;      // start timer
      			} else { Channel_0_CCR = 0x02; }
			}
        } else {
            if(button_state == BUT_PRESSED)
            button_state = BUT_IDLE;
        }
    }
    
    if( fiq & (1<<TC0_ID) ){
		data_out = tc->Channel_0.SR; / / ????T???S? ??S ??G?S ??S ???????S
		aic->ICCR = (1<<TC0_ID); / / ????T???S? ???????S ?? ? ??? A I C
        
		timer_interrupts++;
        if (PWM_STATE == 0){ //if pwm phase is off
            PWM_STATE = 1;
            pioa->SODR = data_out | 0x10;
            pioa->CODR = data_out & 0x10;
            Channel_0_RC = PWM;
        }
        if (PWM_STATE == 1){
            PWM_STATE = 0;
            pioa->SODR = data_out | 0x10;
            pioa->CODR = data_out & 0x10;
            Channel_0_RC = MAX_PWM + 1 - PWM;
        }
        
		tc->Channel_0.CCR = 0x05;  // reset timer and start counting
    }
}
